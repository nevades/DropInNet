/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Interface.java to edit this template
 */
package fintrex.dropinnet.repo;

import fintrex.dropinnet.dto.LastSeenDTO;
import fintrex.dropinnet.dto.TicketDTO;
import fintrex.dropinnet.dto.TicketTrackingDTO;
import fintrex.dropinnet.model.TicketLog;
import org.springframework.data.jdbc.repository.query.Query;
import org.springframework.data.repository.CrudRepository;
import org.springframework.data.repository.query.Param;

/**
 *
 * @author Akash
 */
public interface TicketLogRepo extends CrudRepository<TicketLog, Integer> {

    Iterable<TicketLog> findByTicket(Integer ticket);

    @Query("UPDATE `ticket_log` SET `ticket_age` = TIMESTAMPDIFF(SECOND, `date`, NOW())")
    TicketLog ticketAge(@Param("id") Integer id);
    
    @Query("SELECT `id`,`code`,`priority`,`subject`,`description`,`time_of_incident`,`status`,`ent_on`,`rate`,(SELECT JSON_ARRAYAGG(JSON_OBJECT( 'comment',`comment`,'user',(SELECT `username` FROM `user` WHERE `id`=com.`user_id`),'date',DATE_FORMAT(COALESCE(DATE, NOW()), '%Y-%m-%d %h:%i:%s')))FROM `comments` com WHERE `ticket_id`=t.`id` ) AS comments,(SELECT JSON_ARRAYAGG(JSON_OBJECT('user', (SELECT `username` FROM `user` WHERE id = ta.`user`), 'date', `date`,'act',`action`))FROM (SELECT `user`, `date`,`action` FROM `ticket_log` WHERE `action` IN ('Finish', 'Re-Open by User') AND `ticket` =t.`id` ORDER BY `date` DESC LIMIT 2) ta) AS `closed`,(SELECT `ent_on` FROM `ticket_assign` WHERE `ticket_id`=t.`id` LIMIT 1) AS `assignee_date`,(SELECT `username` FROM `user` WHERE `id`=t.`ent_by`) AS `reporter`,(SELECT `type` FROM `ticket_type` WHERE `id`=t.`ticket_type`) AS `ticket_type`,(SELECT `name` FROM `category_type` WHERE id=t.`category`)AS`category`,(SELECT JSON_ARRAYAGG(JSON_OBJECT('id', `id`,'action', `action`,'data', `date`,'user', (SELECT `name` FROM `user` WHERE id = t2.`user`),'age', (CONCAT(FLOOR(ticket_age / (24*60*60)), ':',LPAD(FLOOR((ticket_age % (24*60*60)) / (60*60)), 2, '0'), ':',LPAD(FLOOR((ticket_age % (60*60)) / 60), 2, '0'), ':',LPAD(ticket_age % 60, 2, '0'))))) FROM (SELECT `id`, `date`, `user`, `action`, TIMESTAMPDIFF(SECOND, `date`, NOW()) AS ticket_age FROM `ticket_log` WHERE `ticket` = t.`id`) AS t2) AS `ticket_log`,(SELECT JSON_OBJECT('user',(SELECT `username` FROM `user` WHERE `id`=tl.`user`),'date',`date`) FROM `ticket_log` tl WHERE `ticket`=t.`id` AND `action`='SEEN' ORDER BY `date` DESC LIMIT 1) AS last_seen, (SELECT JSON_OBJECT('user',(SELECT `username` FROM `user` WHERE `id`=tl.`user`),'date',`date`,'status',`action`) FROM `ticket_log` tl WHERE `ticket`=t.`id` ORDER BY `date` DESC LIMIT 1) AS assignee_detail,(SELECT `name` FROM `ticket_status` WHERE `id`=t.`status`) AS `status`,(SELECT `id` FROM `ticket_job_type` WHERE `id`=t.`job_type`) AS`job_type_id`,(SELECT `name` FROM `ticket_job_type` WHERE `id`=t.`job_type`) AS`job_type`, (SELECT JSON_ARRAYAGG(JSON_OBJECT('id',`id`,'fname',`fullname`,'name',`calling_name`,'epf',`epf`,'join_date',`join_date`,'add',`address`,'phone',`phone`,'nic',`nic`,'gender',`gender`,'location',`location`,'description',`description`,'designation',(SELECT `name` FROM hris_new.`designation` WHERE id=r.`designation`),'nic',`nic`,'branch',(SELECT `name` FROM hris_new.`department` WHERE id=r.`department`))) FROM `recruitment_users` r WHERE `ticket_id`=t.`id`)AS rec_data, (SELECT JSON_OBJECT('user',(SELECT `username` FROM `user` WHERE `id`=tl.`user`),'date',`date`,'status',`action`) FROM `ticket_log` tl WHERE `ticket`=t.`id` ORDER BY `date` DESC LIMIT 1) AS assignee_detail,(SELECT JSON_ARRAYAGG(JSON_OBJECT('id',(SELECT `id` FROM `user` WHERE id=tas.`user_id`),'name',(SELECT `username` FROM `user` WHERE id=tas.`user_id`))) FROM `ticket_assign` tas WHERE `ticket_id`=t.`id`) AS `assignee`,(SELECT JSON_ARRAYAGG(JSON_OBJECT('id', al.`id`,'name', al.`access`,'type', `type`,'hr', IF(ar.`hr` IS NULL, 'fa', 'fa-check') )) FROM `access_list` al LEFT JOIN `access_requests` ar ON al.`id` = ar.`hr` AND ar.`ticket_id` = t.`id`)AS `access_req`,(SELECT JSON_ARRAYAGG(JSON_OBJECT('id', al.`id`,'name', al.`access`,'type', al.`type`,'it', IF(ar.`it` IS NULL, 'NO', 'YES'),'hr', IF(ar2.`hr` IS NULL, 'fa', 'fa-check')))FROM `access_list` al LEFT JOIN `access_requests` ar ON al.`id` = ar.`it` AND ar.`ticket_id`=t.`id` LEFT JOIN `access_requests` ar2 ON al.`id` = ar2.`hr` AND ar2.`ticket_id`=t.`id`) AS checked, (SELECT JSON_ARRAYAGG(JSON_OBJECT('id', al.`id`,'name', al.`access`,'type', `type`,'hr', IF(ar.`hr` IS NULL, 'fa', 'fa-check'),'it', IF(ar.`it` IS NULL, 'NO', 'YES') )) FROM `access_list` al LEFT JOIN `access_requests` ar ON al.`id` = ar.`hr` AND ar.`ticket_id` = t.`id`)AS `access_req`, (SELECT JSON_ARRAYAGG(JSON_OBJECT( 'user',(SELECT `username` FROM `user` WHERE `id`=c.`user_id`),'time',`time_of_chat`,'chat',`chat`))FROM `chat` c WHERE `ticket_id`=t.`id`) AS chat,(SELECT JSON_ARRAYAGG(JSON_OBJECT('id', al.`id`,'name', al.`access`,'type', al.`type`,'it', IF(ar.`it` IS NULL, 'NO', 'YES')))FROM `access_list` al LEFT JOIN `access_requests` ar ON al.`id` = ar.`it` AND ar.`ticket_id`= t.id) AS checked,(SELECT JSON_ARRAYAGG(JSON_OBJECT('lastdate', tu.`last_date`,'join_date', e.`joined_date`,'epf', e.`epf`,'phone', e.`mobile`,'nic', e.`nic`,'fullname', CONCAT(e.`fname`, ' ', e.`lname`,' ',e.`surname`),'designation',(SELECT `name` FROM hris_new.`designation` WHERE id = e.`designation`),'gender',e.`sex`,'dep',(SELECT `name` FROM hris_new.`department` WHERE id = e.`department`),'address',CONCAT(e.`p_address`, '-', e.`p_address_2`)))FROM `termination_users` tu JOIN hris_new.`employee` e ON tu.`employee_id`=e.`id` WHERE tu.`ticket_id`=t.`id`)AS ter_data , (SELECT JSON_ARRAYAGG(JSON_OBJECT('newdep',(SELECT `name` FROM hris_new.`department` WHERE id = tp.`department`),'newbra',(SELECT `name` FROM hris_new.`branch` WHERE id = tp.`branch`),'newdesi',(SELECT `name` FROM hris_new.`designation` WHERE id = tp.`designation`),'join_date', e.`joined_date`,'epf', e.`epf`,'phone', e.`mobile`,'nic', e.`nic`,'fullname', CONCAT(e.`fname`, ' ', e.`lname`,' ',e.`surname`),'designation',(SELECT `name` FROM hris_new.`designation` WHERE id = e.`designation`),'gender',e.`sex`,'dep',(SELECT `name` FROM hris_new.`department` WHERE id = e.`department`),'address',CONCAT(e.`p_address`, '-', e.`p_address_2`)))FROM `transfer_promotion_users` tp JOIN hris_new.`employee` e ON tp.`emp_id`=e.`id` WHERE tp.`ticket_id`=t.`id`)AS tp_data FROM `ticket` t WHERE t.`id`=:id")
    TicketDTO getTicketInfo(@Param("id") Integer id);

    @Query("SELECT (SELECT JSON_ARRAYAGG(JSON_OBJECT('id',`id`,'action',`action`,'data',`date`,'user',(SELECT `name` FROM `user` WHERE id=t2.`user`))) FROM `ticket_log` t2 WHERE `ticket`=t.`id`) AS `ticket_log` FROM `ticket` t WHERE t.`id`=:id")
    TicketDTO getEditLog(@Param("id") Integer id);
    
    @Query("SELECT JSON_ARRAYAGG(JSON_OBJECT('id',`id`,'action',`action`,'date',`date`,'user',(SELECT `username` FROM `user` WHERE `id`=tl.`user`))) FROM `ticket_log` tl WHERE `ticket`=:id")
    TicketTrackingDTO ticketTracking(@Param("id") Integer id);

}
